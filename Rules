#!/usr/bin/env ruby

# compilation rules

@@config = YAML.load_file("./config.yaml")


compile '/mailing-list-posts/' do
  filter :erb
  ## no layout as this gets included in homepage '/'
end

compile '/style/*/' do
  filter :sass
end

compile '/sitemap/' do
  # nothing
end


compile '*' do
  case item[:extension]
  when /md$/, /markdown$/
    filter :erb
    filter :rdiscount
  when /haml$/
    filter :haml
  when /html$/
    filter :erb
  when /sass$/
    filter :sass
  end
  if item[:layout]
    layout item[:layout]
  elsif !item.binary?
    layout 'default'
  end
  filter :google_analytics unless item.binary?
end

# routing rules

route '/mailing-list-posts/' do
  nil
end

route '/mailing-list-posts/[0-9]+/' do
  nil
end

route '/sitemap/' do
  item.identifier.chop + '.xml'
end

route '/style/*/' do
  item.identifier.chop + '.css'
end

# biocViews hierarchy
route '/help/bioc-views/' do
  # note that we rely on the rake :post_compile task to create duplicate versions of this file
  # for each bioC version for which the "new" style BiocViews tree is created.
  "/help/bioc-views/#{config[:release_version]}/BiocViews.html"
end


# index pages (package lists)
route /^\/help\/bioc-views\/package-pages\/all-/ do
  long_repo_name = item.identifier.split("-").last.gsub("/", "")
  repo_map = {"Software" => "bioc", "AnnotationData" => "data/annotation", "ExperimentData" => "data/experiment"}
  version = item[:bioc_version_num]
  "/help/bioc-views/#{version}/#{repo_map[long_repo_name]}/index.html"
end

# package detail pages
route /^\/help\/bioc-views\/package-pages\// do
  pkg_name = item.identifier.split("/").last
  version = item[:bioc_version_num]
  "/help/bioc-views/#{version}/#{item[:repo]}html/#{pkg_name}.html"
end


route '*' do
  if item.binary?
    item.identifier.chop + "." + item[:extension]
  else
    item.identifier + 'index.html'
  end
end

# layouting rules

layout '*', :erb
